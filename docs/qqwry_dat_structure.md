# qqwry.dat 数据结构解析

本文档梳理 qqwry.dat 的二进制格式，以便在 Go 方案中正确解析。

## 整体布局

```
┌──────────┬────────────┬───────────────┐
│ 0x000000 │ 4 字节     │ 首条索引偏移 │
├──────────┼────────────┼───────────────┤
│ 0x000004 │ 4 字节     │ 末条索引偏移 │
├──────────┼────────────┼───────────────┤
│ …        │ 索引区     │ 若干条索引    │
├──────────┼────────────┼───────────────┤
│ …        │ 记录区     │ 地理信息数据  │
└──────────┴────────────┴───────────────┘
```

- 文件头 8 字节指向索引区范围，均采用 **小端序**。
- 索引区由定长 7 字节记录组成，每条索引对应一个 IP 段。
- 记录区存放归属地信息，采用 GB2312/GBK 编码，并以空字节 (`0x00`) 结尾。

## 索引条目格式

每条索引占 7 字节：

| 偏移 | 长度 | 描述             |
| ---- | ---- | ---------------- |
| +0   | 4B   | 起始 IP（小端）  |
| +4   | 3B   | 数据区偏移（LE24） |

> **LE24**：低 3 字节拼接成 24 位无符号整数，表示该 IP 段对应记录在文件中的偏移。

索引区按起始 IP 升序排列，可通过二分查找定位目标 IP 所在区间。

## 记录区结构

数据区以偏移 `recordOffset` 开始，遵循以下格式：

1. 4 字节结束 IP（小端序）。
2. 1 字节跳转模式（`mode`）。
3. 根据 `mode` 不同解析国家与区域字段：
   - `0x01`（重定向模式 1）：
     1. 读取后续 3 字节得到新的偏移 `countryOffset`。
     2. 查看 `countryOffset` 地址的首字节：
        - 若为 `0x02`，再次重定向到真实国家字符串；
        - 否则直接读取以 `0x00` 结尾的字符串作为国家；
     3. 读取国家字符串后的位置继续解析区域信息。
   - `0x02`（重定向模式 2）：
     1. 读取后续 3 字节得到国家字符串偏移；
     2. 区域字段从 `recordOffset+8` 开始解析。
   - 其它值：
     1. `recordOffset+4` 起为国家字符串；
     2. 紧随其后的内容为区域字符串。

> 区域字段解析时若遇到 `0x01/0x02`，同样需要进行重定向处理。

## 特殊标记与清洗

- 部分记录的国家或区域字段可能为 `"CZ88.NET"` 或空串，表示未知信息。
- 字符串通常使用 GBK 编码，需要转换为 UTF-8 才能正常显示。
- 若解析过程中重定向指针越界，应视为损坏数据并忽略该记录。

## 解析流程示例

1. 将 IPv4 地址转换为大端整型（`uint32`）。
2. 在索引区执行二分查找：
   - 读取 `startIP` 与 `endIP` 判断区间关系；
   - 获取对应记录偏移 `recordOffset`。
3. 读取记录区：
   - 获得 `endIP` 验证目标 IP 是否落在区间内；
   - 根据 `mode` 解析国家与区域字符串；
   - 使用 GBK→UTF-8 转码，并对结果执行去空白、标准化处理。

了解以上结构后，可在 Go 中实现线程安全的内存解析器，从而支撑方案 A 的高性能查询需求。
